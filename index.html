<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PCBase ‚Äî –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–∞–∑–∞</title>
<style>
  :root{
    --bg:#071025; --panel:#0b1220; --accent:#4f8cff; --muted:#98a0b3; --card: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, Arial;
    background: linear-gradient(180deg,var(--bg), #03040a);
    color:#e6eef8;
    height:100vh;
    display:flex;
    overflow:hidden;
  }

  /* layout */
  .sidebar{
    width:260px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-right:1px solid rgba(255,255,255,0.03);
    padding:18px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .brand{ font-weight:700; font-size:18px; letter-spacing:0.6px; color:var(--accent) }
  .menu{
    display:flex; flex-direction:column; gap:6px;
  }
  .menu button{
    background:transparent; border:0; color:var(--muted); padding:10px; text-align:left; border-radius:8px; cursor:pointer;
  }
  .menu button.active{ background: rgba(79,140,255,0.12); color: #eaf2ff; box-shadow:0 4px 14px rgba(79,140,255,0.06) }

  .sidebar .mini-controls{ margin-top:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .sidebar .mini-controls button{ padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:var(--card); color:var(--muted) }

  .main{
    flex:1; padding:18px; overflow:auto;
    display:flex; gap:18px; align-items:flex-start;
  }

  .pane{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(2,6,23,0.6); }
  .left-pane{ width:360px; max-height:calc(100vh - 60px); overflow:auto; }
  .right-pane{ flex:1; min-width:540px; max-height:calc(100vh - 60px); overflow:auto; display:flex; flex-direction:column; gap:12px; }

  .header-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px }
  .clock{
    font-weight:700; font-size:18px; color:#fff;
    background:rgba(255,255,255,0.02); padding:8px 10px; border-radius:8px;
  }
  .calendar-mini{ padding:10px; background:rgba(255,255,255,0.02); border-radius:8px; color:var(--muted); font-size:13px }

  /* notes list */
  .list-header{ display:flex; gap:8px; align-items:center; }
  .search{ flex:1; padding:8px 10px; border-radius:10px; border:0; background:rgba(255,255,255,0.02); color:var(--muted) }
  .btn{ padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:var(--accent); color:#fff; }
  .item{ padding:10px; border-radius:8px; background:rgba(255,255,255,0.01); margin-top:8px; cursor:pointer; display:flex; justify-content:space-between; gap:8px; align-items:center; }
  .item .title{ color:#eaf2ff; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px }
  .item .meta{ color:var(--muted); font-size:12px }

  /* editor */
  .editor{
    display:flex; flex-direction:column; gap:10px;
  }
  .editor .title-input{ font-size:20px; padding:8px 10px; border-radius:8px; border:0; background:rgba(255,255,255,0.02); color:#fff }
  .editor textarea{ min-height:320px; resize:vertical; padding:12px; border-radius:8px; border:0; background:rgba(255,255,255,0.02); color:#eaf2ff; font-size:15px; line-height:1.5 }

  .controls-row{ display:flex; gap:8px; align-items:center }
  .muted{ color:var(--muted); font-size:13px }

  /* table editor */
  .tbl-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  table.sheet{ width:100%; border-collapse:collapse; background:transparent; }
  table.sheet td, table.sheet th{ border:1px solid rgba(255,255,255,0.05); padding:8px; min-width:80px; }
  table.sheet th{ background:rgba(255,255,255,0.02); font-weight:700; color:#fff }
  .cell-input{ width:100%; border:0; background:transparent; color:inherit; outline:none }

  /* generators */
  .gen-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px; }
  .gen-card{ padding:12px; border-radius:8px; background:rgba(255,255,255,0.02) }
  .big-out{ font-size:22px; font-weight:700; margin-top:8px; color:#fff }

  footer.note{ color:var(--muted); font-size:12px; margin-top:8px }

  @media (max-width:1100px){
    .left-pane{ display:none }
    .sidebar{ display:none }
    .main{ padding:12px }
  }
</style>
</head>
<body>

  <div class="sidebar">
    <div class="brand">PCBase</div>

    <div class="header-row">
      <div class="clock" id="clock">--:--:--</div>
    </div>

    <div class="calendar-mini" id="miniCal"></div>

    <div class="menu" role="navigation">
      <button id="tab-notes" class="active" onclick="switchTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>
      <button id="tab-tables" onclick="switchTab('tables')">üìä –¢–∞–±–ª–∏—Ü—ã</button>
      <button id="tab-generators" onclick="switchTab('generators')">üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã</button>
      <button id="tab-calendar" onclick="switchTab('calendar')">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
      <button id="tab-db" onclick="switchTab('db')">‚öôÔ∏è –ë–∞–∑–∞</button>
    </div>

    <div class="mini-controls">
      <button onclick="exportDB()">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button onclick="importDB()">–ò–º–ø–æ—Ä—Ç</button>
      <button onclick="clearAll()" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É" style="background:rgba(255,40,40,0.08); color:#ffb3b3">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div style="margin-top:12px" class="muted small">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (IndexedDB). –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.</div>
  </div>

  <div class="main">
    <div class="pane left-pane" id="left-pane">
      <div id="notes-list">
        <div class="list-header">
          <input id="searchInput" class="search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–º–µ—Ç–æ–∫..." oninput="renderNotesList()" />
          <button class="btn" onclick="createNote()">+ –ù–æ–≤–∞—è</button>
        </div>
        <div id="notesContainer" style="margin-top:12px"></div>
      </div>

      <div id="tables-list" style="display:none">
        <div class="list-header">
          <input id="searchTables" class="search" placeholder="–ü–æ–∏—Å–∫ —Ç–∞–±–ª–∏—Ü..." oninput="renderTablesList()" />
          <button class="btn" onclick="createTable()">+ –ù–æ–≤–∞—è</button>
        </div>
        <div id="tablesContainer" style="margin-top:12px"></div>
      </div>

      <div id="generators-list" style="display:none">
        <div class="list-header">
          <input id="searchGen" class="search" placeholder="–ü–æ–∏—Å–∫..." oninput="renderGeneratorsList()" />
          <div style="width:42px"></div>
        </div>
        <div id="gensContainer" style="margin-top:12px"></div>
      </div>

      <div id="db-info" style="display:none">
        <h3 class="small">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–∑–µ</h3>
        <div id="dbDetails" class="small muted">–ó–∞–≥—Ä—É–∂–∞—é...</div>
      </div>

    </div>

    <div class="pane right-pane">

      <div id="notes-editor" class="editor">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center">
          <input id="noteTitle" class="title-input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏" />
          <div class="controls-row">
            <button onclick="saveNote()" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="deleteCurrentNote()" class="btn" style="background:rgba(255,40,40,0.08); color:#ffb3b3">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
        <textarea id="noteBody" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
        <div class="muted">Ctrl/Cmd+S ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏.</div>
      </div>

      <div id="tables-editor" style="display:none; flex-direction:column" >
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center">
          <input id="tableTitle" class="title-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã" />
          <div>
            <div class="tbl-controls">
              <button class="btn" onclick="addCol()">+–ö–æ–ª–æ–Ω–∫–∞</button>
              <button class="btn" onclick="addRow()">+–°—Ç—Ä–æ–∫–∞</button>
              <button class="btn" onclick="saveTable()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn" style="background:rgba(255,40,40,0.08); color:#ffb3b3" onclick="deleteCurrentTable()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div style="overflow:auto; border-radius:6px; margin-top:8px">
          <table class="sheet" id="sheetTable"></table>
        </div>
        <div class="muted">–ö–ª–∏–∫–∞–µ—à—å —è—á–µ–π–∫—É ‚Äî –≤–≤–æ–¥–∏—à—å —Ç–µ–∫—Å—Ç. –°–æ—Ö—Ä–∞–Ω—è–π.</div>
      </div>

      <div id="generators-editor" style="display:none">
        <h2>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã</h2>
        <div class="gen-grid">
          <div class="gen-card">
            <div>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∏—Å–µ–ª</div>
            <div style="margin-top:8px">
              min <input id="g_min" type="number" value="1" style="width:80px"> 
              max <input id="g_max" type="number" value="100" style="width:80px">
            </div>
            <button class="btn" style="margin-top:8px" onclick="genNumber()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <div class="big-out" id="out_number">‚Äî</div>
          </div>

          <div class="gen-card">
            <div>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–º—ë–Ω</div>
            <div style="margin-top:8px">
              <select id="nameType"><option value="ru">–†—É—Å—Å–∫–∏–µ</option><option value="mix">–°–º–µ—à–∞–Ω–Ω—ã–µ</option></select>
            </div>
            <button class="btn" style="margin-top:8px" onclick="genName()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <div class="big-out" id="out_name">‚Äî</div>
          </div>

          <div class="gen-card">
            <div>–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä –≥–æ—Ä–æ–¥–æ–≤</div>
            <div style="margin-top:8px">
              <select id="cityRegion"><option value="global">–ú–∏—Ä</option><option value="eu">–ï–≤—Ä–æ–ø–∞</option><option value="asia">–ê–∑–∏—è</option><option value="ru">–†–§/–öZ</option></select>
            </div>
            <button class="btn" style="margin-top:8px" onclick="genCity()">–°–ª—É—á–∞–π–Ω—ã–π –≥–æ—Ä–æ–¥</button>
            <div class="big-out" id="out_city">‚Äî</div>
          </div>

          <div class="gen-card">
            <div>–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä —Å—Ç—Ä–∞–Ω</div>
            <div style="margin-top:8px">
              <select id="countryRegion"><option value="all">–í—Å–µ</option><option value="europe">–ï–≤—Ä–æ–ø–∞</option><option value="asia">–ê–∑–∏—è</option></select>
            </div>
            <button class="btn" style="margin-top:8px" onclick="genCountry()">–°–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞</button>
            <div class="big-out" id="out_country">‚Äî</div>
          </div>
        </div>
      </div>

      <div id="calendar-editor" style="display:none">
        <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å (2 –≥–æ–¥–∞)</h2>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
          <button class="btn" onclick="prevMonth()">‚Üê</button>
          <div id="calTitle" style="font-weight:700"></div>
          <button class="btn" onclick="nextMonth()">‚Üí</button>
          <div style="margin-left:auto" class="muted">–ü–µ—Ä–∏–æ–¥: <span id="calRange"></span></div>
        </div>
        <div id="calendarGrid" style="overflow:auto"></div>
        <div class="muted" style="margin-top:8px">–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –º–µ—Å—è—Ü–∞–º–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞ –∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ.</div>
      </div>

      <div id="db-editor" style="display:none">
        <h2 class="small">–ë–∞–∑–∞ (IndexedDB)</h2>
        <div class="small muted" id="dbStats"></div>
        <div style="margin-top:12px">
          <button class="btn" onclick="compactDB()">–ö–æ–º–ø—Ä–µ—Å—Å–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn" onclick="exportDB()">–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
          <button class="btn" style="background:rgba(255,40,40,0.08); color:#ffb3b3" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
        <footer class="note">–ë–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –∏ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</footer>
      </div>

    </div>
  </div>

<script>
/* ========= IndexedDB wrapper ========= */
const DB_NAME = 'pcbase_v1';
const DB_VERSION = 1;
let db = null;

function openDB(){
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const idb = e.target.result;
      if(!idb.objectStoreNames.contains('notes')) idb.createObjectStore('notes', { keyPath:'id' });
      if(!idb.objectStoreNames.contains('tables')) idb.createObjectStore('tables', { keyPath:'id' });
      if(!idb.objectStoreNames.contains('meta')) idb.createObjectStore('meta', { keyPath:'id' });
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = e => rej(e.target.error);
  });
}
function idbGetAll(storeName){
  return new Promise((res, rej)=>{
    const tx = db.transaction(storeName, 'readonly');
    const store = tx.objectStore(storeName);
    const req = store.getAll();
    req.onsuccess = ()=> res(req.result);
    req.onerror = ()=> rej(req.error);
  });
}
function idbGet(storeName, key){
  return new Promise((res, rej)=>{
    const tx = db.transaction(storeName, 'readonly');
    const store = tx.objectStore(storeName);
    const req = store.get(key);
    req.onsuccess = ()=> res(req.result);
    req.onerror = ()=> rej(req.error);
  });
}
function idbPut(storeName, obj){
  return new Promise((res, rej)=>{
    const tx = db.transaction(storeName, 'readwrite');
    const store = tx.objectStore(storeName);
    const req = store.put(obj);
    req.onsuccess = ()=> res(req.result);
    req.onerror = ()=> rej(req.error);
  });
}
function idbDelete(storeName, key){
  return new Promise((res, rej)=>{
    const tx = db.transaction(storeName, 'readwrite');
    const store = tx.objectStore(storeName);
    const req = store.delete(key);
    req.onsuccess = ()=> res();
    req.onerror = ()=> rej(req.error);
  });
}
function idbClear(storeName){
  return new Promise((res, rej)=>{
    const tx = db.transaction(storeName, 'readwrite');
    const store = tx.objectStore(storeName);
    const req = store.clear();
    req.onsuccess = ()=> res();
    req.onerror = ()=> rej(req.error);
  });
}

/* ========= Utils ========= */
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,9); }
function nowISO(){ return (new Date()).toISOString(); }
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;') }

/* ========= Init DB & sample ========= */
let state = { currentNoteId:null, currentTableId:null, calYear:null, calMonth:null };
openDB().then(async ()=>{
  await ensureSample();
  renderNotesList();
  renderTablesList();
  updateDBInfo();
  buildMiniCalendar();
  // init calendar month to current
  const d = new Date();
  state.calYear = d.getFullYear(); state.calMonth = d.getMonth();
  renderCalendar();
}).catch(e=>alert('IndexedDB error: '+e));

async function ensureSample(){
  const notes = await idbGetAll('notes');
  const tables = await idbGetAll('tables');
  if(notes.length===0){
    await idbPut('notes', { id: uid('note'), title:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ PCBase', body:'–≠—Ç–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞. –ó–¥–µ—Å—å –∑–∞–º–µ—Ç–∫–∏, —Ç–∞–±–ª–∏—Ü—ã, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã, —á–∞—Å—ã –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 2 –≥–æ–¥–∞.', created: nowISO(), updated: nowISO() });
  }
  if(tables.length===0){
    await idbPut('tables', { id: uid('tbl'), title: '–ü—Ä–∏–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã', cols:['–ö–ª—é—á','–ó–Ω–∞—á–µ–Ω–∏–µ'], rows:[ ['–ü–∞—Ä–∞–º–µ—Ç—Ä A','10'], ['–ü–∞—Ä–∞–º–µ—Ç—Ä B','42'] ], created: nowISO(), updated: nowISO() });
  }
}

/* ========= Notes CRUD ========= */
async function renderNotesList(){
  const container = document.getElementById('notesContainer');
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const all = await idbGetAll('notes');
  const filtered = all.filter(n => !q || (n.title && n.title.toLowerCase().includes(q)) || (n.body && n.body.toLowerCase().includes(q)));
  filtered.sort((a,b)=> (b.updated||b.created).localeCompare(a.updated||a.created));
  container.innerHTML = '';
  for(let note of filtered){
    const el = document.createElement('div');
    el.className='item';
    el.onclick = ()=> openNote(note.id);
    el.innerHTML = `<div><div class="title">${escapeHtml(note.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div><div class="meta">${(new Date(note.updated||note.created)).toLocaleString()}</div></div>
                    <div style="display:flex;gap:8px;align-items:center">
                      <button title="–û—Ç–∫—Ä—ã—Ç—å" onclick="event.stopPropagation(); openNote('${note.id}')">–û</button>
                      <button title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation(); deleteNotePrompt('${note.id}')">‚úï</button>
                    </div>`;
    container.appendChild(el);
  }
  if(!state.currentNoteId && filtered.length) openNote(filtered[0].id);
}

async function createNote(){
  const id = uid('note');
  const obj = { id, title:'–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞', body:'', created: nowISO(), updated: nowISO() };
  await idbPut('notes', obj);
  state.currentNoteId = id;
  renderNotesList(); openNote(id);
}

async function openNote(id){
  await autoSaveNote();
  state.currentNoteId = id;
  const note = await idbGet('notes', id);
  if(!note) return;
  document.getElementById('noteTitle').value = note.title;
  document.getElementById('noteBody').value = note.body;
}

async function saveNote(){
  const id = state.currentNoteId; if(!id) return alert('–í—ã–±–µ—Ä–∏ –∑–∞–º–µ—Ç–∫—É.');
  const title = document.getElementById('noteTitle').value;
  const body = document.getElementById('noteBody').value;
  const obj = await idbGet('notes', id);
  obj.title = title; obj.body = body; obj.updated = nowISO();
  await idbPut('notes', obj);
  renderNotesList();
}
async function autoSaveNote(){
  const id = state.currentNoteId; if(!id) return;
  const title = document.getElementById('noteTitle').value;
  const body = document.getElementById('noteBody').value;
  const old = await idbGet('notes', id); if(!old) return;
  if(old.title !== title || old.body !== body){ old.title = title; old.body = body; old.updated = nowISO(); await idbPut('notes', old); renderNotesList(); }
}
async function deleteNotePrompt(id){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?')) return; await idbDelete('notes', id); if(state.currentNoteId===id){ state.currentNoteId=null; document.getElementById('noteTitle').value=''; document.getElementById('noteBody').value=''; } renderNotesList(); }
async function deleteCurrentNote(){ if(!state.currentNoteId) return alert('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ'); deleteNotePrompt(state.currentNoteId); }

/* ========= Tables (spreadsheet) ========= */
async function renderTablesList(){
  const container = document.getElementById('tablesContainer');
  const q = document.getElementById('searchTables').value.trim().toLowerCase();
  const all = await idbGetAll('tables');
  const filtered = all.filter(t => !q || (t.title && t.title.toLowerCase().includes(q)));
  filtered.sort((a,b)=> (b.updated||b.created).localeCompare(a.updated||a.created));
  container.innerHTML = '';
  for(let t of filtered){
    const el = document.createElement('div');
    el.className='item';
    el.onclick = ()=> openTable(t.id);
    el.innerHTML = `<div><div class="title">${escapeHtml(t.title||'–¢–∞–±–ª–∏—Ü–∞')}</div><div class="meta">${(new Date(t.updated||t.created)).toLocaleString()}</div></div>
                    <div style="display:flex;gap:8px">
                      <button title="–û—Ç–∫—Ä—ã—Ç—å" onclick="event.stopPropagation(); openTable('${t.id}')">–û</button>
                      <button title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation(); deleteTablePrompt('${t.id}')">‚úï</button>
                    </div>`;
    container.appendChild(el);
  }
  if(!state.currentTableId && filtered.length) openTable(filtered[0].id);
}

async function createTable(){
  const id = uid('tbl');
  const obj = { id, title:'–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞', cols:['A','B'], rows:[['','']], created: nowISO(), updated: nowISO() };
  await idbPut('tables', obj);
  state.currentTableId = id; renderTablesList(); openTable(id);
}

async function openTable(id){
  await autoSaveTable();
  state.currentTableId = id;
  const t = await idbGet('tables', id);
  if(!t) return;
  document.getElementById('tableTitle').value = t.title;
  buildSheet(t.cols, t.rows);
}

function buildSheet(cols, rows){
  const table = document.getElementById('sheetTable'); table.innerHTML = '';
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  for(let i=0;i<cols.length;i++){
    const th = document.createElement('th');
    th.innerHTML = `<div style="display:flex;gap:6px;align-items:center">
                      <span contenteditable="true" oninput="onEditCol(${i},this.innerText)">${escapeHtml(cols[i])}</span>
                      <button onclick="removeCol(${i})" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úï</button>
                    </div>`;
    trh.appendChild(th);
  }
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  for(let r=0;r<rows.length;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<cols.length;c++){
      const td = document.createElement('td');
      const v = rows[r] && rows[r][c] !== undefined ? rows[r][c] : '';
      td.innerHTML = `<input class="cell-input" value="${escapeHtml(String(v||''))}" onchange="onCellChange(${r},${c},this.value)" />`;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
}

async function saveTable(){
  const id = state.currentTableId; if(!id) return alert('–í—ã–±–µ—Ä–∏ —Ç–∞–±–ª–∏—Ü—É');
  const title = document.getElementById('tableTitle').value;
  const t = await idbGet('tables', id);
  const sheet = readSheetFromDOM();
  t.title = title; t.cols = sheet.cols; t.rows = sheet.rows; t.updated = nowISO();
  await idbPut('tables', t); renderTablesList();
}

function readSheetFromDOM(){
  const table = document.getElementById('sheetTable');
  const cols = []; const rows = [];
  const ths = table.querySelectorAll('thead th');
  ths.forEach(th => { const txt = th.querySelector('div span') ? th.querySelector('div span').innerText : ''; cols.push(txt); });
  const trs = table.querySelectorAll('tbody tr');
  trs.forEach(tr=>{ const cells=[]; tr.querySelectorAll('input.cell-input').forEach(inp=>cells.push(inp.value)); rows.push(cells); });
  return { cols, rows };
}

async function addCol(){ const id=state.currentTableId; if(!id) return alert('–í—ã–±–µ—Ä–∏ —Ç–∞–±–ª–∏—Ü—É'); const t = await idbGet('tables', id); t.cols.push(''); for(let r=0;r<t.rows.length;r++) t.rows[r].push(''); await idbPut('tables', t); buildSheet(t.cols,t.rows); }
async function addRow(){ const id=state.currentTableId; if(!id) return alert('–í—ã–±–µ—Ä–∏ —Ç–∞–±–ª–∏—Ü—É'); const t = await idbGet('tables', id); const newRow = new Array(t.cols.length).fill(''); t.rows.push(newRow); await idbPut('tables', t); buildSheet(t.cols,t.rows); }
async function removeCol(index){ const id=state.currentTableId; if(!id) return; const t = await idbGet('tables', id); t.cols.splice(index,1); for(let r=0;r<t.rows.length;r++) t.rows[r].splice(index,1); await idbPut('tables', t); buildSheet(t.cols,t.rows); }
function onEditCol(i,val){} function onCellChange(r,c,val){}
async function autoSaveTable(){ const id=state.currentTableId; if(!id) return; const t=await idbGet('tables', id); if(!t) return; const sheet=readSheetFromDOM(); t.cols=sheet.cols; t.rows=sheet.rows; t.updated=nowISO(); await idbPut('tables', t); renderTablesList(); }
async function deleteTablePrompt(id){ if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É?')) return; await idbDelete('tables', id); if(state.currentTableId===id){ state.currentTableId=null; document.getElementById('tableTitle').value=''; document.getElementById('sheetTable').innerHTML=''; } renderTablesList(); }
async function deleteCurrentTable(){ if(!state.currentTableId) return alert('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ'); deleteTablePrompt(state.currentTableId); }

/* ========= Generators ========= */
const RU_NAMES = ["–ê–ª–µ–∫—Å–µ–π","–î–∞–Ω–∏–ª","–ú–∞–∫—Å–∏–º","–ò–ª—å—è","–ï–≥–æ—Ä","–ù–∏–∫–∏—Ç–∞","–°–æ—Ñ–∏—è","–ê–ª–∏–Ω–∞","–ú–∏–ª–∞","–ï–≤–∞","–ö–∏—Ä–∏–ª–ª","–î–µ–Ω–∏—Å","–û–ª—å–≥–∞","–ú–∞—Ä–∏—è","–ê–Ω–Ω–∞"];
const MIX_NAMES = ["Alex","Luna","Noah","Maya","–ê–ª–µ–∫—Å–µ–π","Sofia","–û–ª–µ–≥","Liam","–ò—Ä–∏–Ω–∞","Mila"];
const CITIES = {
  global: ["–ú–æ—Å–∫–≤–∞","–ù—å—é-–ô–æ—Ä–∫","–¢–æ–∫–∏–æ","–ë–µ—Ä–ª–∏–Ω","–õ–æ–Ω–¥–æ–Ω","–ü–∞—Ä–∏–∂","–ê—Å—Ç–∞–Ω–∞","–ú–∏–Ω—Å–∫","–ö–∏–µ–≤","–°–µ—É–ª","–ù–∞–π—Ä–æ–±–∏","–°–∏–¥–Ω–µ–π"],
  eu: ["–ë–µ—Ä–ª–∏–Ω","–õ–æ–Ω–¥–æ–Ω","–ü–∞—Ä–∏–∂","–ü—Ä–∞–≥–∞","–í–∞—Ä—à–∞–≤–∞","–ú–∞–¥—Ä–∏–¥","–†–∏–º","–û—Å–ª–æ"],
  asia: ["–¢–æ–∫–∏–æ","–°–µ—É–ª","–ü–µ–∫–∏–Ω","–®–∞–Ω—Ö–∞–π","–ë–∞–Ω–≥–∫–æ–∫","–î–µ–ª–∏","–ê—Å—Ç–∞–Ω–∞"],
  ru: ["–ú–æ—Å–∫–≤–∞","–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥","–ö–∞–∑–∞–Ω—å","–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫","–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥","–ê—Å—Ç–∞–Ω–∞","–ê–ª–º–∞—Ç—ã"]
};
const COUNTRIES = {
  all: ["–†–æ—Å—Å–∏—è","–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω","–°–®–ê","–ì–µ—Ä–º–∞–Ω–∏—è","–§—Ä–∞–Ω—Ü–∏—è","–ò—Ç–∞–ª–∏—è","–ö–∏—Ç–∞–π","–Ø–ø–æ–Ω–∏—è","–ö–æ—Ä–µ—è","–¢—É—Ä—Ü–∏—è","–ò—Å–ø–∞–Ω–∏—è"],
  europe: ["–ì–µ—Ä–º–∞–Ω–∏—è","–§—Ä–∞–Ω—Ü–∏—è","–ò—Ç–∞–ª–∏—è","–ò—Å–ø–∞–Ω–∏—è","–ü–æ–ª—å—à–∞","–ß–µ—Ö–∏—è","–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã"],
  asia: ["–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω","–ö–∏—Ç–∞–π","–Ø–ø–æ–Ω–∏—è","–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è","–ò–Ω–¥–∏—è","–¢—É—Ä—Ü–∏—è"]
};

function genNumber(){
  const min = parseInt(document.getElementById('g_min').value) || 0;
  const max = parseInt(document.getElementById('g_max').value) || 100;
  const out = Math.floor(Math.random()*(max-min+1))+min;
  document.getElementById('out_number').textContent = out;
}
function genName(){
  const type = document.getElementById('nameType').value;
  const arr = type==='ru' ? RU_NAMES : MIX_NAMES;
  document.getElementById('out_name').textContent = pick(arr);
}
function genCity(){
  const region = document.getElementById('cityRegion').value;
  const arr = CITIES[region] || CITIES['global'];
  document.getElementById('out_city').textContent = pick(arr);
}
function genCountry(){
  const region = document.getElementById('countryRegion').value;
  const arr = COUNTRIES[region] || COUNTRIES['all'];
  document.getElementById('out_country').textContent = pick(arr);
}

/* ========= DB utilities ========= */
async function exportDB(){
  const notes = await idbGetAll('notes');
  const tables = await idbGetAll('tables');
  const data = { exportedAt: nowISO(), notes, tables };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = 'pcbase_export_'+ (new Date()).toISOString().slice(0,19).replaceAll(':','-') + '.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importDB(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange = async e => {
    const file = e.target.files[0]; if(!file) return;
    const txt = await file.text();
    try{
      const parsed = JSON.parse(txt);
      if(!parsed) return alert('–ü–ª–æ—Ö–æ–π —Ñ–∞–π–ª');
      if(Array.isArray(parsed.notes)){
        for(let n of parsed.notes){ if(!n.id) n.id = uid('note'); await idbPut('notes', n); }
      }
      if(Array.isArray(parsed.tables)){
        for(let t of parsed.tables){ if(!t.id) t.id = uid('tbl'); await idbPut('tables', t); }
      }
      alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      renderNotesList(); renderTablesList(); updateDBInfo();
    }catch(err){ alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: '+err) }
  };
  inp.click();
}
async function clearAll(){
  if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–º–µ—Ç–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã.')) return;
  await idbClear('notes'); await idbClear('tables');
  state.currentNoteId=null; state.currentTableId=null;
  document.getElementById('noteTitle').value=''; document.getElementById('noteBody').value='';
  document.getElementById('tableTitle').value=''; document.getElementById('sheetTable').innerHTML='';
  renderNotesList(); renderTablesList(); updateDBInfo();
}
async function compactDB(){
  const notes = await idbGetAll('notes'); for(let n of notes){ n.updated = n.updated || n.created || nowISO(); await idbPut('notes', n); }
  const tables = await idbGetAll('tables'); for(let t of tables){ t.updated = t.updated || t.created || nowISO(); await idbPut('tables', t); }
  alert('–ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); updateDBInfo();
}
async function updateDBInfo(){
  const ns = await idbGetAll('notes'); const ts = await idbGetAll('tables');
  document.getElementById('dbStats').innerText = `–ó–∞–º–µ—Ç–æ–∫: ${ns.length} ¬∑ –¢–∞–±–ª–∏—Ü: ${ts.length}`;
  document.getElementById('dbDetails').innerText = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleString()}`;
}

/* ========= UI: tabs, keyboard, autosave ========= */
function switchTab(name){
  const tabs = ['notes','tables','generators','calendar','db'];
  tabs.forEach(t=>{
    document.getElementById(t+'-list') && (document.getElementById(t+'-list').style.display = 'none');
    document.getElementById(t+'-editor') && (document.getElementById(t+'-editor').style.display = 'none');
    document.getElementById('tab-'+t) && document.getElementById('tab-'+t).classList.remove('active');
  });
  document.getElementById('tab-'+name).classList.add('active');
  if(document.getElementById(name+'-list')) document.getElementById(name+'-list').style.display='';
  if(document.getElementById(name+'-editor')) document.getElementById(name+'-editor').style.display='';
  if(name==='db') updateDBInfo();
  // auto-save when switching
  autoSaveNote(); autoSaveTable();
}

window.addEventListener('keydown', async (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault();
    const notesVisible = document.getElementById('notes-editor').style.display !== 'none';
    if(notesVisible){ await saveNote(); alert('–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); } else { await saveTable(); alert('–¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); }
  }
});
window.addEventListener('beforeunload', async (e)=>{ await autoSaveNote(); await autoSaveTable(); });

/* ========= Clock & mini calendar ========= */
function updateClock(){
  const el = document.getElementById('clock');
  const now = new Date(); const hh = String(now.getHours()).padStart(2,'0'); const mm = String(now.getMinutes()).padStart(2,'0'); const ss = String(now.getSeconds()).padStart(2,'0');
  el.textContent = `${hh}:${mm}:${ss}`;
}
setInterval(updateClock, 500); updateClock();

function buildMiniCalendar(){
  const el = document.getElementById('miniCal');
  const now = new Date();
  const opts = { weekday:'short', month:'short', day:'numeric' };
  el.textContent = now.toLocaleDateString(undefined, opts);
}

/* ========= Full calendar (2 years) ========= */
const MONTHS = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
function renderCalendar(){
  const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
  const year = state.calYear; const month = state.calMonth;
  const title = document.getElementById('calTitle'); title.textContent = `${MONTHS[month]} ${year}`;
  const start = new Date(year, month, 1).getDay(); // 0-6 (Sun-Sat) -> adjust to Mon?
  const firstWeekday = (new Date(year, month, 1).getDay()+6)%7; // 0 = Mon
  const days = new Date(year, month+1, 0).getDate();
  const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"].forEach(d=>{ const th=document.createElement('th'); th.textContent=d; th.style.padding='6px'; th.style.background='rgba(255,255,255,0.02)'; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  let row = document.createElement('tr'); let cellIndex = 0;
  for(let i=0;i<firstWeekday;i++){ const td=document.createElement('td'); td.style.padding='8px'; td.innerHTML=''; row.appendChild(td); cellIndex++; }
  for(let d=1; d<=days; d++){
    if(cellIndex===7){ tbody.appendChild(row); row=document.createElement('tr'); cellIndex=0; }
    const td = document.createElement('td'); td.style.padding='8px'; td.style.border='1px solid rgba(255,255,255,0.03)';
    td.innerHTML = `<div style="min-height:28px">${d}</div>`;
    // highlight today
    const today = new Date();
    if(today.getFullYear()===year && today.getMonth()===month && today.getDate()===d){
      td.style.background = 'rgba(79,140,255,0.12)'; td.style.fontWeight='700';
    }
    row.appendChild(td); cellIndex++;
  }
  while(cellIndex>0 && cellIndex<7){ const td=document.createElement('td'); td.style.padding='8px'; td.innerHTML=''; row.appendChild(td); cellIndex++; }
  tbody.appendChild(row); table.appendChild(tbody); grid.appendChild(table);
  // range display
  const now = new Date(); const r0 = `${now.getFullYear()}`; const r1 = `${now.getFullYear()+1}`;
  document.getElementById('calRange').textContent = `${r0} ‚Äî ${r1}`;
}

function prevMonth(){
  // don't go below current year-month
  const now = new Date();
  const minYear = now.getFullYear();
  const minMonth = now.getMonth();
  let y = state.calYear; let m = state.calMonth - 1;
  if(m<0){ y-=1; m=11; }
  if(y<minYear || (y===minYear && m<minMonth)) return;
  state.calYear=y; state.calMonth=m; renderCalendar();
}
function nextMonth(){
  const now = new Date();
  const maxYear = now.getFullYear()+1;
  let y = state.calYear; let m = state.calMonth + 1;
  if(m>11){ y+=1; m=0; }
  if(y>maxYear || (y===maxYear && m>11)) return;
  state.calYear=y; state.calMonth=m; renderCalendar();
}

/* ========= Generators list render (left pane quick access) ========= */
function renderGeneratorsList(){
  const cont = document.getElementById('gensContainer'); cont.innerHTML = '';
  const items = [
    {id:'g_numbers', title:'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∏—Å–µ–ª', action:'genNumber'},
    {id:'g_names', title:'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–º—ë–Ω', action:'genName'},
    {id:'g_cities', title:'–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä –≥–æ—Ä–æ–¥–æ–≤', action:'genCity'},
    {id:'g_countries', title:'–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä —Å—Ç—Ä–∞–Ω', action:'genCountry'}
  ];
  for(let it of items){
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div><div class="title">${it.title}</div><div class="meta">–ù–∞–∂–º–∏ —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div></div>
                    <div style="display:flex;gap:8px"><button onclick="event.stopPropagation(); switchTab('generators');">${'–û'}</button></div>`;
    cont.appendChild(el);
  }
}

/* ========= small helpers ========= */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ========= initial UI state ========= */
switchTab('notes'); renderGeneratorsList();

/* ========= Keyboard: quick gen via keys (optional) ========= */
document.addEventListener('keydown', (e)=>{
  if(e.key==='F8'){ switchTab('generators'); genNumber(); }
});
</script>

</body>
</html>
